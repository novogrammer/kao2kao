import Head from 'next/head'
import { useRef ,useState} from 'react';
import { useMount,useUnmount } from "react-use";
import MainClientApp from '../client/MainClientApp';
import RemoteVideo from '../components/RemoteVideo';
// import getConfig from "next/config";
// const { publicRuntimeConfig } = getConfig();

import styles from "../styles/Home.module.scss";

export default function Home({iceServers}) {
  const clientAppRef=useRef(null);
  const localVideoRef=useRef(null);
  const [joined,setJoined]=useState(false);

  const viewRef=useRef(null);

  useMount(async ()=>{
    const localVideo=localVideoRef.current;
    const view=viewRef.current;
    const clientApp=new MainClientApp({
      localVideo,
      iceServers,
      view,
      setJoined,
    });
    window.clientApp=clientApp;
    clientAppRef.current=clientApp;
    await clientApp.setupPromise;
  });
  useUnmount(async ()=>{
    const clientApp=clientAppRef.current;
    await clientApp.destroyAsync();
  });
  const onClickJoin=()=>{
    const clientApp=clientAppRef.current;
    clientApp.onClickJoin();
  }
  const cameraClassNames=[
    styles["waiting__camera"],
  ];
  if(joined){
    cameraClassNames.push(styles["waiting__camera--joined"]);
  }
  const onButtonDown=(name)=>{
    const clientApp=clientAppRef.current;
    clientApp.onButtonDown(name);
  };
  const onButtonUp=(name)=>{
    const clientApp=clientAppRef.current;
    clientApp.onButtonUp(name);
  };
  const onTouchStart=(name,event)=>{
    event.preventDefault();
    onButtonDown(name,event);
  }
  const onTouchEnd=(name,event)=>{
    onButtonUp(name,event);
  }
  const onTouchCancel=(name,event)=>{
    onButtonUp(name,event);
  }

  return (
    <div className={styles.home}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        {/* <link rel="icon" href="/favicon.ico" /> */}
      </Head>
      <div className={styles.background}>
        <canvas ref={viewRef}></canvas>
      </div>
      <div className={styles.waiting}>
        <video className={cameraClassNames.join(" ")} ref={localVideoRef} autoPlay playsInline muted />
        {!joined && <button className={styles.waiting__join} onClick={onClickJoin}>join</button>}
      </div>
      <div className={styles.controller}>
      <div className={styles.controller__up} onMouseDown={onButtonDown.bind(null,"ButtonUp")} onMouseUp={onButtonUp.bind(null,"ButtonUp")} onTouchStart={onTouchStart.bind(null,"ButtonUp")} onTouchEnd={onTouchEnd.bind(null,"ButtonUp")} onTouchCancel={onTouchCancel.bind(null,"ButtonUp")}>up</div>
      <div className={styles.controller__left} onMouseDown={onButtonDown.bind(null,"ButtonLeft")} onMouseUp={onButtonUp.bind(null,"ButtonLeft")} onTouchStart={onTouchStart.bind(null,"ButtonLeft")} onTouchEnd={onTouchEnd.bind(null,"ButtonLeft")} onTouchCancel={onTouchCancel.bind(null,"ButtonLeft")}>left</div>
      <div className={styles.controller__down} onMouseDown={onButtonDown.bind(null,"ButtonDown")} onMouseUp={onButtonUp.bind(null,"ButtonDown")} onTouchStart={onTouchStart.bind(null,"ButtonDown")} onTouchEnd={onTouchEnd.bind(null,"ButtonDown")} onTouchCancel={onTouchCancel.bind(null,"ButtonDown")}>down</div>
      <div className={styles.controller__right} onMouseDown={onButtonDown.bind(null,"ButtonRight")} onMouseUp={onButtonUp.bind(null,"ButtonRight")} onTouchStart={onTouchStart.bind(null,"ButtonRight")} onTouchEnd={onTouchEnd.bind(null,"ButtonRight")} onTouchCancel={onTouchCancel.bind(null,"ButtonRight")}>right</div>
      </div>

    </div>
  )
}

export async function getServerSideProps(context){
  const iceServers=[
    {
      urls: process.env.TURN_SERVER_URI,
      username:process.env.TURN_SERVER_USER,
      credential:process.env.TURN_SERVER_PASSWORD,
    },
  ];

  return {
    props:{
      iceServers,
    },
  };
}